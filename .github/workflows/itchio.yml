name: Publish to itch.io (HTML5)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  web-build-and-push:
    runs-on: ubuntu-latest
    env:
      ITCH_USER: Athyverse
      ITCH_GAME: Trilero_web
      ITCH_CHANNEL: html5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install -U pip
          python -m pip install -r requirements.txt
          python -m pip install -U pygbag

      - name: Build web (pygbag)
        run: |
          python -m pygbag --build .

      - name: Patch index.html to use CDN
        shell: bash
        run: |
          sed -i \
            -e 's/="\/archives\//="https:\/\/pygame-web.github.io\/archives\//g' \
            -e 's#//archives/#https://pygame-web.github.io/archives/#g' \
            -e 's#https://pygame-web.github.io/archives//#https://pygame-web.github.io/archives/#g' \
            build/web/index.html

      - name: Zip web folder (artifact)
        shell: bash
        run: |
          (cd build && zip -r web.zip web/*)

      - name: Upload web.zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-zip
          path: build/web.zip

      - name: Download butler (linux)
        shell: bash
        run: |
          url="https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default"
          curl -L -f -o butler.zip "$url"
          unzip -o butler.zip -d "$GITHUB_WORKSPACE"
          chmod +x "$GITHUB_WORKSPACE/butler"
          echo "$GITHUB_WORKSPACE" >> $GITHUB_PATH

      - name: Push to itch.io
        shell: bash
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        run: |
          "$GITHUB_WORKSPACE/butler" push build/web "$ITCH_USER/$ITCH_GAME:$ITCH_CHANNEL"
